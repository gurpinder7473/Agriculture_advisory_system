{% extends "base.html" %}

{% block title %}Crop Recommendation Results - Agriculture Advisory System{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="text-center mb-5">
                <div class="hero-section py-5 rounded-4">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-seedling me-3"></i>AI Crop Recommendations
                    </h1>
                    <p class="lead mb-0">Based on your soil and environmental conditions</p>
                </div>
            </div>

            <!-- Input Summary -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Analysis Parameters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Nitrogen (N)</small>
                            <div class="fw-bold">{{ input_data.nitrogen }} kg/ha</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Phosphorus (P)</small>
                            <div class="fw-bold">{{ input_data.phosphorus }} kg/ha</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Potassium (K)</small>
                            <div class="fw-bold">{{ input_data.potassium }} kg/ha</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Temperature</small>
                            <div class="fw-bold">{{ input_data.temperature }}°C</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Humidity</small>
                            <div class="fw-bold">{{ input_data.humidity }}%</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Soil pH</small>
                            <div class="fw-bold">{{ input_data.ph }}</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Rainfall</small>
                            <div class="fw-bold">{{ input_data.rainfall }} mm</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommended Crops -->
            <div class="row">
                {% for crop in crops %}
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm {{ 'border-success' if loop.index == 1 else '' }}">
                        {% if loop.index == 1 %}
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-trophy me-1"></i>Best Match
                            </span>
                        </div>
                        {% endif %}

                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-leaf fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h4 class="card-title mb-1">{{ crop.name }}</h4>
                                    <p class="text-muted mb-0">Rank #{{ loop.index }}</p>
                                </div>
                            </div>

                            <!-- Confidence Score -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">AI Confidence</span>
                                    <span class="badge bg-{{ 'success' if crop.confidence > 80 else 'warning' if crop.confidence > 60 else 'secondary' }}">
                                        {{ crop.confidence }}%
                                    </span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-{{ 'success' if crop.confidence > 80 else 'warning' if crop.confidence > 60 else 'secondary' }}" 
                                         style="width: {{ crop.confidence }}%"></div>
                                </div>
                            </div>

                            <!-- Expected Yield -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Expected Yield</span>
                                    <span class="fw-bold text-success">{{ crop.expected_yield }}</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="getCropDetails('{{ crop.name }}')">
                                    <i class="fas fa-info-circle me-2"></i>View Details
                                </button>
                                <button class="btn btn-success" onclick="selectCrop('{{ crop.name }}')">
                                    <i class="fas fa-check me-2"></i>Select This Crop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Additional Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card bg-light border-0">
                        <div class="card-body text-center py-4">
                            <h5 class="mb-3">What's Next?</h5>
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <a href="{{ url_for('fertilizer_recommendation') }}" class="btn btn-success">
                                    <i class="fas fa-flask me-2"></i>Get Fertilizer Advice
                                </a>
                                <a href="{{ url_for('weather_alerts') }}" class="btn btn-info">
                                    <i class="fas fa-cloud-sun me-2"></i>Check Weather
                                </a>
                                <a href="{{ url_for('market_prices') }}" class="btn btn-warning">
                                    <i class="fas fa-chart-line me-2"></i>View Market Prices
                                </a>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#voiceModal">
                                    <i class="fas fa-microphone me-2"></i>Ask Questions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save/Share Options -->
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <button class="btn btn-outline-secondary me-2" onclick="saveRecommendation()">
                        <i class="fas fa-save me-2"></i>Save Recommendation
                    </button>
                    <button class="btn btn-outline-secondary me-2" onclick="shareRecommendation()">
                        <i class="fas fa-share me-2"></i>Share Results
                    </button>
                    <a href="{{ url_for('crop_recommendation') }}" class="btn btn-outline-primary">
                        <i class="fas fa-redo me-2"></i>New Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Crop Details Modal -->
<div class="modal fade" id="cropDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-seedling me-2"></i>Crop Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cropDetailsContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function getCropDetails(cropName) {
    const modal = new bootstrap.Modal(document.getElementById('cropDetailsModal'));
    const content = document.getElementById('cropDetailsContent');

    // Sample crop details - replace with actual data
    const cropDetails = {
        'Rice': {
            scientific: 'Oryza sativa',
            season: 'Kharif (Monsoon)',
            duration: '120-150 days',
            water: 'High (1200-1500mm)',
            soil: 'Clay loam, well-drained',
            temperature: '20-35°C',
            benefits: ['High yield potential', 'Good market demand', 'Suitable for your conditions'],
            challenges: ['Water intensive', 'Disease prone in wet conditions']
        },
        'Wheat': {
            scientific: 'Triticum aestivum',
            season: 'Rabi (Winter)',
            duration: '110-130 days',
            water: 'Medium (450-650mm)',
            soil: 'Well-drained loamy soil',
            temperature: '15-25°C',
            benefits: ['Lower water requirement', 'Good storage life', 'Stable market'],
            challenges: ['Temperature sensitive', 'Requires timely sowing']
        }
    };

    const details = cropDetails[cropName] || {};

    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Scientific Name:</strong></td><td>${details.scientific || 'N/A'}</td></tr>
                    <tr><td><strong>Growing Season:</strong></td><td>${details.season || 'N/A'}</td></tr>
                    <tr><td><strong>Duration:</strong></td><td>${details.duration || 'N/A'}</td></tr>
                    <tr><td><strong>Water Requirement:</strong></td><td>${details.water || 'N/A'}</td></tr>
                    <tr><td><strong>Soil Type:</strong></td><td>${details.soil || 'N/A'}</td></tr>
                    <tr><td><strong>Temperature:</strong></td><td>${details.temperature || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Benefits</h6>
                <ul class="list-unstyled">
                    ${(details.benefits || []).map(b => `<li><i class="fas fa-check text-success me-2"></i>${b}</li>`).join('')}
                </ul>
                <h6>Challenges</h6>
                <ul class="list-unstyled">
                    ${(details.challenges || []).map(c => `<li><i class="fas fa-exclamation-triangle text-warning me-2"></i>${c}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;

    modal.show();
}

function selectCrop(cropName) {
    if (confirm(`Are you sure you want to select ${cropName} for cultivation?`)) {
        // Redirect to fertilizer recommendation with selected crop
        window.location.href = `/fertilizer-recommendation?selected_crop=${encodeURIComponent(cropName)}`;
    }
}

function saveRecommendation() {
    // Save recommendation to user's account
    fetch('/api/recommendations/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crops: {{ crops | tojsonfilter }},
            input_data: {{ input_data | tojsonfilter }}
        })
    }).then(response => {
        if (response.ok) {
            alert('Recommendation saved successfully!');
        }
    });
}

function shareRecommendation() {
    if (navigator.share) {
        navigator.share({
            title: 'My Crop Recommendations',
            text: 'Check out my AI-powered crop recommendations!',
            url: window.location.href
        });
    } else {
        // Fallback: copy link to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }
}
</script>
{% endblock %}