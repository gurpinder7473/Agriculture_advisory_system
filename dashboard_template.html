{% extends "base.html" %}

{% block title %}Dashboard - Agriculture Advisory System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section text-center rounded-4">
                <div class="container">
                    <h1 class="display-4 fw-bold mb-3">
                        Welcome, {{ current_user.first_name }}! 🌾
                    </h1>
                    <p class="lead mb-4">Your AI-powered agriculture companion is ready to help you maximize your farm's potential</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="{{ url_for('crop_recommendation') }}" class="btn btn-light btn-lg">
                            <i class="fas fa-wheat-awn me-2"></i>Get Crop Advice
                        </a>
                        <a href="{{ url_for('disease_detection') }}" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-microscope me-2"></i>Detect Disease
                        </a>
                        <button class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#voiceModal">
                            <i class="fas fa-microphone me-2"></i>Voice Assistant
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-tractor fa-2x mb-3"></i>
                    <h3 class="fw-bold">{{ farms|length }}</h3>
                    <p class="mb-0">Active Farms</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-seedling fa-2x mb-3"></i>
                    <h3 class="fw-bold">{{ recommendations|length }}</h3>
                    <p class="mb-0">AI Recommendations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card weather-widget h-100">
                <div class="card-body text-center">
                    <i class="fas fa-cloud-sun fa-2x mb-3"></i>
                    <h3 class="fw-bold">28°C</h3>
                    <p class="mb-0">Current Temperature</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card market-price-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-3"></i>
                    <h3 class="fw-bold">₹4,250</h3>
                    <p class="mb-0">Rice Price/Quintal</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row">
        <!-- Recent Recommendations -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-robot me-2 text-primary"></i>Recent AI Recommendations
                        </h5>
                        <a href="{{ url_for('crop_recommendation') }}" class="btn btn-sm btn-outline-primary">
                            Get New Recommendation
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recommendations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Farm</th>
                                        <th>Season</th>
                                        <th>Recommended Crops</th>
                                        <th>Confidence</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rec in recommendations %}
                                    <tr>
                                        <td>{{ rec.created_at.strftime('%d %b %Y') }}</td>
                                        <td>
                                            {% for farm in farms %}
                                                {% if farm.id == rec.farm_id %}
                                                    {{ farm.farm_name }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ rec.season.title() }}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ rec.recommended_crops[:100] }}...</small>
                                        </td>
                                        <td>
                                            {% if rec.confidence_score %}
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" style="width: {{ (rec.confidence_score * 100)|round|int }}%"></div>
                                                </div>
                                                <small>{{ (rec.confidence_score * 100)|round|int }}%</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewRecommendation({{ rec.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-seedling fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No recommendations yet</h5>
                            <p class="text-muted">Get your first AI-powered crop recommendation!</p>
                            <a href="{{ url_for('crop_recommendation') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Get Recommendation
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Notifications -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('crop_recommendation') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-wheat-awn me-2"></i>Crop Recommendation
                        </a>
                        <a href="{{ url_for('fertilizer_recommendation') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-flask me-2"></i>Fertilizer Advice
                        </a>
                        <a href="{{ url_for('disease_detection') }}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-microscope me-2"></i>Disease Detection
                        </a>
                        <a href="{{ url_for('weather_alerts') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-cloud-sun me-2"></i>Weather Alerts
                        </a>
                        <a href="{{ url_for('market_prices') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-chart-line me-2"></i>Market Prices
                        </a>
                        <a href="{{ url_for('add_farm') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-plus me-2"></i>Add New Farm
                        </a>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="card">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell me-2 text-info"></i>Recent Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% if notifications %}
                        {% for notification in notifications %}
                        <div class="alert alert-{{ 'warning' if notification.priority == 'high' else 'info' if notification.priority == 'medium' else 'light' }} py-2 px-3 mb-2">
                            <div class="d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">
                                        {% if notification.notification_type == 'weather_alert' %}
                                            <i class="fas fa-cloud-rain me-1"></i>
                                        {% elif notification.notification_type == 'disease_outbreak' %}
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                        {% elif notification.notification_type == 'market_price' %}
                                            <i class="fas fa-chart-line me-1"></i>
                                        {% else %}
                                            <i class="fas fa-info-circle me-1"></i>
                                        {% endif %}
                                        {{ notification.title }}
                                    </h6>
                                    <p class="mb-1" style="font-size: 0.8rem;">{{ notification.message }}</p>
                                    <small class="text-muted">{{ notification.created_at.strftime('%d %b, %I:%M %p') }}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="markAsRead({{ notification.id }})">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-bell-slash fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No new alerts</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Farm Overview -->
    {% if farms %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map-marked-alt me-2 text-success"></i>Your Farms Overview
                        </h5>
                        <a href="{{ url_for('farm_management') }}" class="btn btn-sm btn-outline-success">
                            Manage All Farms
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for farm in farms %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h6 class="card-title mb-0">{{ farm.farm_name }}</h6>
                                        <span class="badge bg-{{ 'success' if farm.farm_type == 'organic' else 'primary' }}">
                                            {{ farm.farm_type.title() }}
                                        </span>
                                    </div>
                                    <div class="text-muted small">
                                        <p class="mb-1">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ farm.location.city }}, {{ farm.location.state }}
                                        </p>
                                        <p class="mb-1">
                                            <i class="fas fa-ruler-combined me-1"></i>
                                            {{ farm.total_area }} acres
                                        </p>
                                        <p class="mb-1">
                                            <i class="fas fa-tint me-1"></i>
                                            {{ farm.irrigation_type.replace('_', ' ').title() if farm.irrigation_type else 'Not specified' }}
                                        </p>
                                        <p class="mb-0">
                                            <i class="fas fa-mountain me-1"></i>
                                            {{ farm.soil_type or 'Soil test pending' }}
                                        </p>
                                    </div>
                                </div>
                                <div class="card-footer bg-light border-0">
                                    <div class="d-flex gap-2">
                                        <a href="#" class="btn btn-sm btn-outline-primary flex-fill">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-success flex-fill">
                                            <i class="fas fa-seedling"></i> Recommend
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Voice Assistant Tutorial Modal -->
<div class="modal fade" id="voiceTutorialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="fas fa-graduation-cap me-2"></i>Voice Assistant Tutorial
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-language me-2"></i>Supported Languages</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>English</li>
                            <li><i class="fas fa-check text-success me-2"></i>हिंदी (Hindi)</li>
                            <li><i class="fas fa-check text-success me-2"></i>বাংলা (Bengali)</li>
                            <li><i class="fas fa-check text-success me-2"></i>తెలుగు (Telugu)</li>
                            <li><i class="fas fa-check text-success me-2"></i>தமிழ் (Tamil)</li>
                            <li><i class="fas fa-check text-success me-2"></i>And 7 more...</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-question-circle me-2"></i>Sample Questions</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-microphone text-primary me-2"></i>"My crops are yellowing"</li>
                            <li><i class="fas fa-microphone text-primary me-2"></i>"What fertilizer to use?"</li>
                            <li><i class="fas fa-microphone text-primary me-2"></i>"Weather forecast for farming"</li>
                            <li><i class="fas fa-microphone text-primary me-2"></i>"Best crops for my soil"</li>
                            <li><i class="fas fa-microphone text-primary me-2"></i>"Pest control advice"</li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Speak clearly and describe your farming issue in detail for better AI recommendations.
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#voiceModal">
                    Try Voice Assistant Now
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show voice tutorial on first visit
    if (!localStorage.getItem('voiceTutorialShown')) {
        setTimeout(() => {
            new bootstrap.Modal(document.getElementById('voiceTutorialModal')).show();
            localStorage.setItem('voiceTutorialShown', 'true');
        }, 2000);
    }

    // Auto-refresh weather data every 30 minutes
    setInterval(updateWeatherData, 30 * 60 * 1000);
});

function viewRecommendation(recommendationId) {
    // Show recommendation details in modal
    alert('Feature coming soon: View detailed recommendation #' + recommendationId);
}

function markAsRead(notificationId) {
    // Mark notification as read
    fetch(`/api/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

function updateWeatherData() {
    // Update weather information
    fetch('/api/weather/current')
        .then(response => response.json())
        .then(data => {
            // Update weather display
            console.log('Weather updated:', data);
        });
}

// Real-time notifications using Server-Sent Events (if implemented)
function initializeRealTimeNotifications() {
    const eventSource = new EventSource('/api/notifications/stream');

    eventSource.onmessage = function(event) {
        const notification = JSON.parse(event.data);
        showToastNotification(notification);
    };
}

function showToastNotification(notification) {
    const toast = document.createElement('div');
    toast.className = 'toast position-fixed bottom-0 end-0 m-3';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="toast-header">
            <i class="fas fa-bell text-primary me-2"></i>
            <strong class="me-auto">${notification.title}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${notification.message}
        </div>
    `;

    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}